# ADAPTIVE REGIME BLENDING - IMPLEMENTATION GUIDE
## Building a Dynamic Multi-Sleeve Portfolio System
### November 4, 2025

---

## ðŸ“‹ EXECUTIVE SUMMARY

**Objective:** Build an adaptive portfolio system that dynamically adjusts sleeve weights based on market regime.

**Current State:**
- Static blend: TC 50% / TI 30% / HC 20% â†’ Sharpe 0.59
- Works OK but ignores market conditions

**Target State:**
- Adaptive blend: Dynamic weights by regime â†’ Sharpe 0.75-0.85
- Exploits sleeve strengths, avoids weaknesses

**Expected Improvement:** +0.15-0.25 Sharpe (+25-42% improvement)

**Time to Build:** 3-6 hours depending on scope

---

## ðŸŽ¯ WHY ADAPTIVE BLENDING IS ESSENTIAL

### The Problem with Static Blending

**Current approach:**
```python
portfolio = 0.50 * TrendCore + 0.30 * TrendImpulse + 0.20 * HookCore
# Same weights ALWAYS, regardless of market conditions
```

**What this means:**
- When market is trending (17% of time): Under-allocating to best performers
- When market is choppy (77.5% of time): Over-allocating to losing strategies
- Missing 25-42% of potential Sharpe

### The Data-Driven Solution

**Markets have distinct regimes with different dynamics:**

```
REGIME COVERAGE BY SLEEVE:

                TRENDING      TRANSITIONAL   RANGING
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Low â”‚    5.8% âœ…âœ…         37.5% âš ï¸          3.7% âœ…    â”‚
    â”‚   TC: 2.44         TC: 0.01         TC: -0.08  â”‚
    â”‚   TI: 5.06         TI: -0.24        TI: 2.14   â”‚
    â”‚   HC: -0.25        HC: 0.31         HC: 0.76   â”‚
    â”‚   Best: TC+TI      Best: HC         Best: TI+HCâ”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Med â”‚    5.2% âœ…          21.6% âœ…âœ…        1.6% âœ…     â”‚
    â”‚   TC: 2.24         TC: -0.25        TC: -0.50  â”‚
    â”‚   TI: 1.60         TI: -0.33        TI: -0.46  â”‚
    â”‚   HC: -0.09        HC: 1.07 ðŸš€      HC: 0.38   â”‚
    â”‚   Best: TC+TI      Best: HC!        Best: HC   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Highâ”‚    6.0% âœ…          18.5% âŒâŒ        0.2% â”€     â”‚
    â”‚   TC: 2.90         TC: -0.53                   â”‚
    â”‚   TI: 3.14         TI: -1.28                   â”‚
    â”‚   HC: -0.55        HC: -0.18                   â”‚
    â”‚   Best: TC+TI      Best: GO DEFENSIVE!         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key insight:** The "best" sleeve changes dramatically by regime.

---

## ðŸ—ï¸ SYSTEM ARCHITECTURE

### Components Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ADAPTIVE PORTFOLIO SYSTEM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   REGIME     â”‚ â”‚   WEIGHT     â”‚ â”‚  PORTFOLIO   â”‚
â”‚  DETECTOR    â”‚ â”‚  CALCULATOR  â”‚ â”‚   BLENDER    â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ â€¢ Vol regime â”‚ â”‚ â€¢ Regime map â”‚ â”‚ â€¢ Load       â”‚
â”‚ â€¢ Trend reg. â”‚ â”‚ â€¢ Smooth     â”‚ â”‚   sleeves    â”‚
â”‚ â€¢ Chop prob  â”‚ â”‚   transitionsâ”‚ â”‚ â€¢ Apply      â”‚
â”‚              â”‚ â”‚ â€¢ Risk       â”‚ â”‚   weights    â”‚
â”‚              â”‚ â”‚   overlay    â”‚ â”‚ â€¢ Generate   â”‚
â”‚              â”‚ â”‚              â”‚ â”‚   position   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   OUTPUTS    â”‚
                â”‚              â”‚
                â”‚ â€¢ Daily PnL  â”‚
                â”‚ â€¢ Metrics    â”‚
                â”‚ â€¢ Regime log â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š WHAT WE ALREADY HAVE

### 1. âœ… Regime Detection Framework

**File:** `regime.py` (production-ready)

**Features:**
- Vol regime detection (low/medium/high)
- Trend regime detection (trending/ranging/transitional)
- Chop probability calculation (0-1)
- Validated on historical periods

**Usage:**
```python
from regime import RegimeDetector

detector = RegimeDetector()
regimes = detector.detect_all_regimes(df)

# Returns DataFrame with:
# - vol_regime: 'low', 'medium', 'high'
# - trend_regime: 'trending', 'ranging', 'transitional'
# - chop_probability: 0-1
```

**Available:** `/mnt/user-data/outputs/regime.py`

### 2. âœ… Complete Regime Classifications

**File:** `copper_regimes_full.csv`

**Coverage:** 6,718 days (2000-2025), 97.8% valid

**Available:** `/mnt/user-data/outputs/copper_regimes_full.csv`

### 3. âœ… Regime-Stratified Performance Analysis

**Files:**
- `regime_performance.py` - Analysis tools
- `regime_analysis_summary.md` - Full strategic report

**Key data:**
- Sharpe ratio for each sleeve in each of 9 regime combinations
- Gap analysis (where sleeves fail)
- Time-weighted contributions
- Portfolio coverage map

**Available:** `/mnt/user-data/outputs/`

### 4. âœ… Sleeve Daily Series

**Files:**
- `daily_series_trendcore_v3.csv`
- `daily_series_trendimpulse_v4.csv`
- `daily_series_hookcore_v4.csv` (if using HC)

**Columns:** date, price, ret, pos, pos_for_ret_t, trade, cost, pnl_gross, pnl_net

---

## ðŸ› ï¸ WHAT WE NEED TO BUILD

### 1. âŒ Adaptive Portfolio Manager

**File to create:** `src/core/portfolio.py`

**Purpose:** Core engine that blends sleeves dynamically

**Key classes:**
```python
class AdaptivePortfolio:
    """
    Dynamically blends multiple sleeves based on market regime.
    """
    
    def __init__(self, sleeves_dict, regime_detector, weight_rules):
        """
        Args:
            sleeves_dict: {'TrendCore': tc_df, 'TrendImpulse': ti_df, ...}
            regime_detector: RegimeDetector instance
            weight_rules: Dict mapping regimes to weights
        """
        self.sleeves = sleeves_dict
        self.detector = regime_detector
        self.weights = weight_rules
    
    def calculate_regime_weights(self, regime):
        """
        Given a regime, return optimal sleeve weights.
        
        Args:
            regime: Dict with vol_regime, trend_regime, chop_probability
        
        Returns:
            Dict: {'TrendCore': 0.50, 'TrendImpulse': 0.30, ...}
        """
        # Logic maps regime â†’ weights
        # Example: If low vol + trending â†’ TI 60%, TC 30%, HC 10%
        pass
    
    def generate_portfolio_position(self, date):
        """
        Generate blended position for a given date.
        
        Returns:
            (position, regime, weights, metadata)
        """
        # 1. Detect regime
        # 2. Calculate weights
        # 3. Blend sleeve positions
        # 4. Return combined position
        pass
    
    def backtest_adaptive_strategy(self):
        """
        Full historical backtest with adaptive blending.
        
        Returns:
            (daily_series_df, metrics_dict, regime_log_df)
        """
        pass
    
    def compare_static_vs_adaptive(self, static_weights):
        """
        Compare adaptive blend to static benchmark.
        """
        pass
```

### 2. âŒ Weight Rules Configuration

**File to create:** `Config/Copper/portfolio.yaml`

**Purpose:** Define weight rules for each regime

**Structure:**
```yaml
io:
  commodity: Copper
  portfolio_name: AdaptiveBlend_v1

sleeves:
  TrendCore:
    path: outputs/Copper/TrendCore_v3/daily_series.csv
    default_weight: 0.50
  
  TrendImpulse:
    path: outputs/Copper/TrendImpulse_v4/daily_series.csv
    default_weight: 0.30
  
  HookCore:
    path: outputs/Copper/HookCore_v4/daily_series.csv
    default_weight: 0.20
    enabled: false  # Can disable if not ready

regime_weights:
  # LOW VOL REGIMES
  low_vol_trending:
    TrendCore: 0.30
    TrendImpulse: 0.60  # TI shines (Sharpe 5.06)
    HookCore: 0.10
    rationale: "Exploit TI's massive edge in low vol trends"
  
  low_vol_transitional:
    TrendCore: 0.30
    TrendImpulse: 0.20
    HookCore: 0.50      # HC best here (Sharpe 0.31)
    rationale: "TC flat, TI negative, HC positive"
  
  low_vol_ranging:
    TrendCore: 0.10
    TrendImpulse: 0.30  # TI good (Sharpe 2.14)
    HookCore: 0.60      # HC good (Sharpe 0.76)
    rationale: "Mean reversion + momentum range trading"
  
  # MEDIUM VOL REGIMES
  medium_vol_trending:
    TrendCore: 0.50     # TC good (Sharpe 2.24)
    TrendImpulse: 0.40  # TI good (Sharpe 1.60)
    HookCore: 0.10
    rationale: "Both trend followers work well"
  
  medium_vol_transitional:
    TrendCore: 0.20
    TrendImpulse: 0.10
    HookCore: 0.70      # HC excellent (Sharpe 1.07!)
    rationale: "HC's sweet spot - exploit this!"
  
  medium_vol_ranging:
    TrendCore: 0.10
    TrendImpulse: 0.20
    HookCore: 0.70      # HC decent (Sharpe 0.38)
    rationale: "Mean reversion dominant"
  
  # HIGH VOL REGIMES
  high_vol_trending:
    TrendCore: 0.50     # TC good (Sharpe 2.90)
    TrendImpulse: 0.40  # TI good (Sharpe 3.14)
    HookCore: 0.10
    rationale: "Both momentum strategies work"
  
  high_vol_transitional:
    # DEATH ZONE - all sleeves fail
    TrendCore: 0.20
    TrendImpulse: 0.05  # TI disaster (Sharpe -1.28)
    HookCore: 0.25
    Cash: 0.50          # Go defensive!
    rationale: "All sleeves negative - reduce exposure"
  
  high_vol_ranging:
    # Rare, no data - use default
    TrendCore: 0.33
    TrendImpulse: 0.33
    HookCore: 0.34
    rationale: "Insufficient data - equal weight"

transition_smoothing:
  enabled: true
  window_days: 5  # Smooth weight changes over 5 days
  rationale: "Avoid whipsaw from regime oscillation"

risk_overlay:
  max_leverage: 1.0  # Portfolio level cap
  vol_target: 0.10   # 10% annual vol target
```

### 3. âŒ Builder Script

**File to create:** `src/cli/build_adaptive_portfolio.py`

**Purpose:** CLI tool to build adaptive portfolio

**Structure:**
```python
#!/usr/bin/env python3
"""
Build Adaptive Portfolio - Multi-Sleeve Dynamic Blending
"""

import argparse
import pandas as pd
import yaml
from pathlib import Path
import sys

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from src.core.portfolio import AdaptivePortfolio
from src.core.regime import RegimeDetector

def main():
    parser = argparse.ArgumentParser(description='Build adaptive portfolio')
    parser.add_argument('--config', required=True, help='Path to portfolio.yaml')
    parser.add_argument('--outdir', required=True, help='Output directory')
    parser.add_argument('--compare-static', action='store_true', 
                       help='Compare to static blend benchmark')
    args = parser.parse_args()
    
    # 1. Load config
    print("Loading configuration...")
    with open(args.config) as f:
        cfg = yaml.safe_load(f)
    
    # 2. Load sleeve data
    print("Loading sleeve data...")
    sleeves = {}
    for sleeve_name, sleeve_cfg in cfg['sleeves'].items():
        if sleeve_cfg.get('enabled', True):
            df = pd.read_csv(sleeve_cfg['path'])
            sleeves[sleeve_name] = df
            print(f"  âœ“ {sleeve_name}: {len(df)} days")
    
    # 3. Initialize regime detector
    print("Initializing regime detector...")
    detector = RegimeDetector()
    
    # 4. Initialize adaptive portfolio
    print("Building adaptive portfolio...")
    portfolio = AdaptivePortfolio(
        sleeves_dict=sleeves,
        regime_detector=detector,
        weight_rules=cfg['regime_weights']
    )
    
    # 5. Run backtest
    print("Running backtest...")
    daily_series, metrics, regime_log = portfolio.backtest_adaptive_strategy()
    
    # 6. Save outputs
    print(f"Saving outputs to {args.outdir}...")
    Path(args.outdir).mkdir(parents=True, exist_ok=True)
    
    daily_series.to_csv(f"{args.outdir}/daily_series.csv", index=False)
    regime_log.to_csv(f"{args.outdir}/regime_log.csv", index=False)
    
    with open(f"{args.outdir}/summary_metrics.json", 'w') as f:
        json.dump(metrics, f, indent=2)
    
    # 7. Print summary
    print("\n" + "="*80)
    print("ADAPTIVE PORTFOLIO RESULTS")
    print("="*80)
    print(f"Sharpe Ratio:    {metrics['sharpe']:.3f}")
    print(f"Annual Return:   {metrics['annual_return']*100:.2f}%")
    print(f"Annual Vol:      {metrics['annual_vol']*100:.2f}%")
    print(f"Max Drawdown:    {metrics['max_drawdown']*100:.2f}%")
    
    # 8. Compare to static if requested
    if args.compare_static:
        print("\nComparing to static blend...")
        static_weights = {name: cfg['sleeves'][name]['default_weight'] 
                         for name in sleeves.keys()}
        comparison = portfolio.compare_static_vs_adaptive(static_weights)
        
        print("\n" + "="*80)
        print("STATIC vs ADAPTIVE COMPARISON")
        print("="*80)
        print(f"Static Sharpe:   {comparison['static_sharpe']:.3f}")
        print(f"Adaptive Sharpe: {comparison['adaptive_sharpe']:.3f}")
        print(f"Improvement:     +{comparison['improvement']:.3f} ({comparison['improvement_pct']:.1f}%)")

if __name__ == "__main__":
    main()
```

### 4. âŒ Batch File (Windows)

**File to create:** `run_adaptive_portfolio.bat`

```batch
@echo off
echo ========================================
echo Building Adaptive Portfolio
echo ========================================
python src\cli\build_adaptive_portfolio.py --config Config\Copper\portfolio.yaml --outdir outputs\Copper\AdaptivePortfolio --compare-static

if %errorlevel% neq 0 (
    echo.
    echo âŒ Build failed!
    pause
    exit /b 1
)

echo.
echo âœ… Build complete!
pause
```

---

## ðŸ“‹ IMPLEMENTATION PLAN

### Phase 1: 2-Sleeve MVP (3-4 hours)

**Goal:** Prove adaptive blending works with TC + TI only

**Why start with 2 sleeves:**
- Simpler to build and debug
- HookCore v4 weak (Sharpe 0.26), better to add HC v5 later
- Still get most of the benefit

**Steps:**
1. **Build portfolio.py core** (2 hours)
   - AdaptivePortfolio class
   - Weight calculation logic
   - Position blending
   - Backtest function

2. **Create portfolio.yaml** (30 min)
   - Weight rules for 9 regimes (TC + TI only)
   - Based on performance data

3. **Build builder script** (1 hour)
   - CLI wrapper
   - Output generation
   - Static vs adaptive comparison

4. **Test & validate** (30 min)
   - Run on full history
   - Check metrics make sense
   - Compare to static blend

**Expected outcome:**
- Static (TC 70% / TI 30%): Sharpe ~0.57
- Adaptive (regime-aware): Sharpe 0.65-0.70
- **Improvement: +0.08-0.13 Sharpe**

### Phase 2: Add HookCore v5 (1 hour)

**When:** After HC v5 is confirmed working (Sharpe >0.50)

**Steps:**
1. Add HC to sleeves dict in portfolio.yaml
2. Update weight rules to include HC
3. Re-run backtest

**Expected outcome:**
- Adaptive with HC v5: Sharpe 0.75-0.80
- **Additional improvement: +0.10-0.15 Sharpe**

### Phase 3: Add ChopCore (2 hours)

**When:** After ChopCore v1 is built

**Steps:**
1. Add ChopCore to system (4th sleeve)
2. Update weight rules for ranging regimes
3. Re-run backtest

**Expected outcome:**
- Adaptive with 4 sleeves: Sharpe 0.80-0.85
- **Additional improvement: +0.05-0.10 Sharpe**

---

## ðŸŽ¯ SUCCESS CRITERIA

### Minimum (Must Achieve)
- [ ] Adaptive system runs without errors
- [ ] Sharpe >0.65 (vs static 0.57-0.59)
- [ ] Regime transitions are smooth (no oscillation)
- [ ] Weights make intuitive sense by regime

### Target (Should Achieve)
- [ ] Sharpe >0.70 with 2 sleeves
- [ ] Sharpe >0.75 with 3 sleeves (+ HC v5)
- [ ] Sharpe >0.80 with 4 sleeves (+ ChopCore)
- [ ] Max drawdown <-15%

### Stretch (World-Class)
- [ ] Sharpe >0.85 with full system
- [ ] Outperforms static by >0.20 Sharpe
- [ ] Works robustly in all historical periods

---

## ðŸ“Š KEY DESIGN DECISIONS

### Decision 1: How to Handle Regime Transitions?

**Problem:** Regimes can oscillate (low vol â†’ high vol â†’ low vol in 3 days)

**Options:**
1. **Instant transition** - Change weights immediately
   - Pro: Responsive
   - Con: Whipsaw, high turnover

2. **Smoothed transition** - Blend weights over 5-10 days
   - Pro: Stable, lower turnover
   - Con: Slight lag

3. **Hysteresis** - Require regime to persist N days before changing
   - Pro: Avoids false signals
   - Con: Misses quick regime changes

**Recommendation:** **Smoothed transition (option 2)**
- Use 5-day exponential moving average of weights
- Balances responsiveness with stability
- Industry standard approach

**Implementation:**
```python
# Smooth weight transitions
current_weights = ema_weights.iloc[-1]  # Yesterday's weights
target_weights = calculate_regime_weights(regime)  # Today's target
alpha = 0.2  # 5-day halflife
new_weights = alpha * target_weights + (1 - alpha) * current_weights
```

### Decision 2: What to Do in High Vol + Transitional?

**Problem:** All sleeves fail in this regime (18.5% of time)

**Options:**
1. **Stay invested** - Use least-bad allocation
   - TC 50%, TI 10%, HC 40%
   - Still loses money but less

2. **Go defensive** - Reduce overall exposure
   - TC 20%, TI 5%, HC 25%, Cash 50%
   - Protect capital

3. **Flat** - 0% exposure
   - Sit out completely
   - Miss any potential gains

**Recommendation:** **Go defensive (option 2)**
- Reduce exposure but don't go completely flat
- TC still has positive expectancy (Sharpe -0.53 not terrible)
- Gives small exposure in case regime changes quickly

### Decision 3: Should Weights Sum to 100% or Scale to Vol Target?

**Options:**
1. **Sum to 100%** - Fully invested always
   - Weights always sum to 1.0
   - Simple, transparent

2. **Vol-scaled** - Target portfolio vol
   - Weights vary, total position = target_vol / realized_vol
   - More sophisticated

**Recommendation:** **Sum to 100% (option 1) for Phase 1**
- Easier to understand and debug
- Each sleeve already vol-targeted internally
- Can add portfolio-level vol targeting in Phase 2

### Decision 4: How Many Regime Combinations?

**Full matrix:** 3 vol Ã— 3 trend = 9 combinations

**Could simplify:**
- Combine high/medium vol in some cases
- Combine transitional/ranging in some cases
- â†’ Reduce to 5-6 rules

**Recommendation:** **Use all 9 combinations**
- Data shows distinct performance in each
- Medium vol + transitional is HC sweet spot (can't merge)
- Configuration file handles complexity, not code

---

## ðŸ” TESTING & VALIDATION

### Validation Checklist

**1. Smoke Tests**
- [ ] System runs without errors
- [ ] All dates have regime classifications
- [ ] All dates have valid weights
- [ ] Weights sum to ~1.0 (allowing for smoothing)
- [ ] No NaN positions or PnL

**2. Sanity Checks**
- [ ] Low vol + trending â†’ TI gets high weight (>50%)
- [ ] Medium vol + transitional â†’ HC gets high weight (>60%)
- [ ] High vol + transitional â†’ reduced overall exposure
- [ ] Regime log shows reasonable transition frequency

**3. Performance Checks**
- [ ] Adaptive Sharpe > Static Sharpe
- [ ] Improvement is meaningful (>+0.05)
- [ ] Max drawdown reasonable (<-20%)
- [ ] No extreme leverage spikes

**4. Regime-Stratified Validation**
- [ ] Check performance in each regime separately
- [ ] Verify adaptive outperforms in weak regimes
- [ ] Verify adaptive maintains edge in strong regimes

**5. Historical Period Validation**
- [ ] 2011-12 (Eurozone crisis): Should go defensive
- [ ] 2015-16 (China slowdown): Should favor HC
- [ ] 2018-19 (Trade war): Should favor HC in ranging
- [ ] 2020-21 (COVID): Should favor TC/TI in trends

---

## ðŸ“ˆ EXPECTED RESULTS

### Performance Projections

**Static Blend Baseline:**
- TC 50% / TI 30% / HC 20%: Sharpe 0.59
- TC 70% / TI 30% (2-sleeve): Sharpe 0.57

**Adaptive Blend Projections:**

**Phase 1 (TC + TI only):**
- Conservative: Sharpe 0.65 (+0.08)
- Target: Sharpe 0.70 (+0.13)
- Optimistic: Sharpe 0.72 (+0.15)

**Phase 2 (+ HookCore v5):**
- Conservative: Sharpe 0.72 (+0.13)
- Target: Sharpe 0.77 (+0.18)
- Optimistic: Sharpe 0.82 (+0.23)

**Phase 3 (+ ChopCore):**
- Conservative: Sharpe 0.77 (+0.18)
- Target: Sharpe 0.82 (+0.23)
- Optimistic: Sharpe 0.87 (+0.28)

### Calculation Methodology

**Time-weighted contribution:**
```python
# Example: Low vol + trending (5.8% of time)
# Static: TC 50% (2.44) + TI 30% (5.06) = weighted 3.30
# Adaptive: TC 30% (2.44) + TI 60% (5.06) = weighted 3.77
# Improvement in this regime: 0.47 Sharpe

# Across all 9 regimes:
# Sum improvements weighted by frequency
# Expected: +0.15-0.25 Sharpe overall
```

---

## ðŸš¨ COMMON PITFALLS TO AVOID

### 1. Over-Optimization
**Problem:** Fitting weights perfectly to historical data
**Solution:** Use simple rules, test on out-of-sample periods

### 2. Regime Oscillation
**Problem:** Weights change daily, high turnover
**Solution:** Smooth transitions over 5 days, avoid whipsaw

### 3. Look-Ahead Bias
**Problem:** Using future data to classify past regimes
**Solution:** Regime detection uses only T-1 data (already enforced)

### 4. Overfitting to Rare Regimes
**Problem:** Optimizing for regimes that occur <1% of time
**Solution:** Use default weights for sparse regimes

### 5. Ignoring Costs
**Problem:** Weight changes create trading costs
**Solution:** Account for rebalancing costs in backtests

---

## ðŸ“š REFERENCE DOCUMENTS

**All available in:** `/mnt/user-data/outputs/`

1. **MASTER_BRIEF_v1.md** - Overall project roadmap
2. **SESSION_SUMMARY_Nov4.md** - Today's work summary
3. **regime_analysis_summary.md** - Strategic performance analysis (13 pages)
4. **regime.py** - Production regime detector
5. **regime_performance.py** - Analysis tools
6. **copper_regimes_full.csv** - Complete regime history
7. **HOOKCORE_V5_CORRECTED_REQUIREMENTS.md** - HC specifications

---

## ðŸŽ¬ NEXT SESSION STARTER

**Use this to start the next chat:**

> "Hi! I want to build an adaptive portfolio blending system for my copper trading model.
> 
> I have:
> - 3 sleeves: TrendCore v3 (Sharpe 0.51), TrendImpulse v4 (Sharpe 0.42), HookCore v4 (Sharpe 0.26)
> - Static blend: Sharpe 0.59
> - Complete regime detection framework (production-ready)
> - Regime-stratified performance data (know exactly when each sleeve works)
> 
> I want to build:
> - Adaptive blending system that adjusts weights by regime
> - Target: Sharpe 0.75-0.85 (vs static 0.59)
> - Start with 2-sleeve MVP (TC + TI), add HC later
> 
> I have a complete implementation guide ready. Let's build the adaptive portfolio manager.
> 
> Should we start with the core portfolio.py class or the configuration file first?"

---

## âœ… DELIVERABLES CHECKLIST

When done, you should have:

**Code:**
- [ ] `src/core/portfolio.py` - Adaptive portfolio manager
- [ ] `src/cli/build_adaptive_portfolio.py` - Builder script
- [ ] `run_adaptive_portfolio.bat` - Batch file

**Configuration:**
- [ ] `Config/Copper/portfolio.yaml` - Weight rules

**Outputs:**
- [ ] `outputs/Copper/AdaptivePortfolio/daily_series.csv`
- [ ] `outputs/Copper/AdaptivePortfolio/summary_metrics.json`
- [ ] `outputs/Copper/AdaptivePortfolio/regime_log.csv`
- [ ] `outputs/Copper/AdaptivePortfolio/comparison_report.txt`

**Documentation:**
- [ ] Architecture doc (this file)
- [ ] Results summary
- [ ] Regime behavior analysis

---

## ðŸ’ª YOU'RE READY TO BUILD

**You have everything needed:**
- âœ… Regime detection framework (production-ready)
- âœ… Complete performance data by regime
- âœ… Clear design specifications
- âœ… Implementation roadmap
- âœ… Expected outcomes quantified

**Time estimate:** 3-6 hours depending on scope

**Expected improvement:** +0.15-0.25 Sharpe (+25-42%)

**Risk:** Low (can always revert to static blend)

---

**Let's build something world-class.** ðŸš€

---

*Document Date: November 4, 2025*  
*Version: 1.0*  
*Status: Ready for implementation*  
*Next: Start new chat and begin building*