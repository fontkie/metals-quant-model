# Config/Copper/trendimpulse_v6.yaml

io:
  commodity: Copper
  sleeve: TrendImpulse_v6

policy:
  calendar:
    exec_weekdays: [0, 1, 2, 3, 4]  # Mon-Fri
    origin_for_exec:
      "0": "-1B"
      "1": "-1B"
      "2": "-1B"
      "3": "-1B"
      "4": "-1B"
    fill_default: close_T

  sizing:
    ann_target: 0.10                    # 10% target vol
    vol_lookback_days_default: 63       # ~3 months rolling vol
    leverage_cap_default: 3.0           # Max 3x leverage (Layer 2 will handle)

  costs:
    one_way_bps_default: 3.0            # 3 bps per trade (institutional reality)

  pnl:
    formula: pos_lag_times_simple_return
    t_plus_one_pnl: true                # T+1 accrual

# TrendImpulse v6 signal parameters (LAYER 1 ONLY)
signal:
  # Core strategy
  strategy_version: "6.0"
  description: "ADX-Filtered Quality Momentum - Trending Markets Specialist"
  architecture: "Pure signal in Layer 1, vol targeting in Layer 2, costs in Layer 4"
  
  # Momentum parameters (same as V5)
  momentum_window: 20                   # 20-day momentum lookback
  
  # Asymmetric entry/exit (same as V5)
  entry_threshold: 0.010                # 1.0% - need conviction to enter
  exit_threshold: 0.003                 # 0.3% - patient exit
  reason_asymmetric: "Reduces whipsaw in choppy markets, improves win rate"
  
  # ADX filter (NEW IN V6 - KEY IMPROVEMENT)
  adx_trending_threshold: 20.0          # ADX >= 20 = trending, < 20 = ranging
  adx_window: 14                        # Standard ADX calculation window
  reason_adx: "Only trade when ADX >= 20, go FLAT in ranging markets"
  improvement: "Eliminates -1.5 Sharpe disasters in choppy periods"
  
  # Turnover reduction (same as V5)
  weekly_vol_updates: true              # Update vol/regime weekly (not daily)
  update_frequency: 5                   # Update every 5 trading days
  reason_weekly: "Reduces turnover by ~40% vs daily updates"
  
  # Regime scaling (UPDATED medium_vol_scale from V5's 0.4 to 0.8)
  use_regime_scaling: true
  vol_window: 63                        # Vol calculation window
  vol_percentile_window: 252            # Percentile ranking window
  low_vol_threshold: 0.40               # Bottom 40% = low vol
  medium_vol_threshold: 0.75            # 40-75% = medium vol
  low_vol_scale: 1.5                    # 1.5x in low vol (best edge)
  medium_vol_scale: 0.8                 # 0.8x in medium vol (UPDATED from 0.4!)
  high_vol_scale: 0.7                   # 0.7x in high vol (reduce exposure)
  reason_regime: "Overweight low vol edge, underweight weak medium vol"
  
  # Notes on Layer 1
  notes:
    - "Pure signal generation with ADX filter and regime-based strategic scaling"
    - "ADX filter is KEY FEATURE: only trades when ADX >= 20 (trending)"
    - "Goes FLAT when ADX < 20 (ranging markets) - complements RangeFader"
    - "Regime scaling is STRATEGIC (when to be aggressive), not calibration"
    - "Vol targeting applied separately in Layer 2 (closed-loop EWMA)"
    - "Costs applied once on net portfolio in Layer 4"
    - "Expected raw signal: -1.5 to +1.5 (due to regime scaling), 0 when ranging"

# Expected performance (validated 2000-2025, after full 4-layer processing)
expected_performance:
  overall:
    net_sharpe: 0.343                 # ~0.34 overall (72% activity)
    gross_sharpe: 0.40                # ~0.40 before costs
    annual_return: 0.034              # 3.4% @ 3bps
    annual_vol: 0.10                  # 10% (via closed-loop vol targeting)
    max_drawdown: -0.26               # -26% (slightly higher than V5)
    turnover: 580                     # 580x annual (lower than V5 due to less activity)
    activity: 0.72                    # 72% time in market (only when trending)
  
  in_regime:
    net_sharpe: 0.416                 # ~0.42 when ADX >= 20 (in trending markets)
    activity: 1.00                    # 100% when in regime (by definition)
    note: "Superior to V5's 0.369 unconditional Sharpe"
  
  validation:
    data_period: "2000-2025"
    observations: 6718
    note: "Validated on 25 years of copper LME 3mo data with 4-layer architecture"

# Cost impact analysis
cost_analysis:
  gross_sharpe: 0.40
  cost_drag: 0.057                  # 0.057 Sharpe points @ 3bps
  net_sharpe: 0.343
  cost_as_pct_gross: 0.14           # ~14% of gross returns
  note: "Lower turnover than V5 due to less activity, still profitable"

# Portfolio contribution (CRITICAL - V6 is better in portfolio context)
portfolio_metrics:
  correlation_trendcore: 0.38
  correlation_momentumcore: 0.25
  correlation_rangefader: -0.05       # Near zero - perfect complement!
  diversification: "LOW correlation with other strategies, HIGH with RangeFader"
  
  standalone_net_sharpe: 0.343
  in_regime_sharpe: 0.416
  role: "Trending markets specialist, complements RangeFader"
  
  regime_coverage:
    adx_below_17: "RangeFader dominates (+1.32 Sharpe)"
    adx_17_20: "Transition zone (8.4% of time) - acceptable gap"
    adx_above_20: "TrendImpulse V6 dominates (+0.416 Sharpe)"
  
  regime_adaptive_blend:
    allocation_choppy: "40% RangeFader + 20% TrendImpulse + 40% TrendCore"
    allocation_trending: "0% RangeFader + 40% TrendImpulse + 40% TrendCore + 20% Momentum"
    expected_sharpe: "0.75-0.85"
    improvement: "+13-28% vs static 0.665 baseline"
  
  recommendation: "Deploy V6 for regime-adaptive portfolio, superior to V5 in multi-strategy context"

# Comparison to TrendImpulse V5
vs_v5:
  v5_sharpe: 0.369
  v5_activity: 0.90                   # Always on
  v5_role: "Best standalone"
  
  v6_sharpe_overall: 0.343            # Lower overall (by design)
  v6_sharpe_in_regime: 0.416          # Higher in trending markets!
  v6_activity: 0.72                   # Only when trending
  v6_role: "Best for portfolio"
  
  key_insight: "V6's lower overall Sharpe is a FEATURE not a bug"
  explanation: "V6 specializes in trends, complements RangeFader perfectly"
  portfolio_advantage: "V6 achieves 0.75-0.85 portfolio Sharpe vs V5's 0.70"
  
  when_to_use_v5: "Standalone deployment, want 90% activity"
  when_to_use_v6: "Portfolio deployment, have RangeFader for choppy markets"

# Data requirements (CRITICAL - V6 needs OHLC)
data:
  required:
    - copper_lme_3mo_canonical.csv      # Close prices
    - copper_lme_3mo_high_canonical.csv # High prices (for ADX)
    - copper_lme_3mo_low_canonical.csv  # Low prices (for ADX)
  
  optional:
    - None                              # No external regime data needed
  
  notes:
    - "ADX requires OHLC data (high, low, close)"
    - "Strategy self-generates regime classification from price vol"
    - "20-day momentum lookback requires 20 days warmup"
    - "ADX calculation requires 14 days warmup"
    - "Vol regime needs 252 days for percentile calculation"
    - "Total warmup: max(20, 14, 252) = 252 days"

# Architecture notes
architecture:
  layer_1: "generate_trendimpulse_v6_signal() - pure signal with ADX filter + regime scaling"
  layer_2: "apply_vol_targeting() - closed-loop EWMA targeting"
  layer_3: "Single sleeve for now (future: regime-based blending)"
  layer_4: "execute_single_sleeve() - costs once on net position"
  
  critical:
    - "ADX filter is PURE STRATEGY LOGIC (Layer 1), not calibration"
    - "Regime scaling is STRATEGIC (Layer 1), not calibration"
    - "NO vol targeting in signal function"
    - "Costs applied ONCE on net portfolio (institutional standard)"
    - "Closed-loop vol targeting ensures 10% realized vol"
    - "Enhanced classification in vol_targeting.py handles regime-dependent strategies"
    - "All validation checks must pass"
  
  vol_targeting_classification:
    approach: "Automatic via enhanced classify_strategy_type() in vol_targeting.py"
    v6_classification: "regime-dependent (65-85% activity, <20 day gaps)"
    method_used: "always_on (EWMA of strategy returns, not sparse)"
    why_enhanced: "V6, VolCore, TightStocks are regime-dependent (not truly sparse)"
    categories:
      pure_always_on: ">95% activity - continuous positioning"
      mostly_on: "85-95% activity, <15 day gaps - continuous with brief gaps"
      regime_dependent: "65-85% activity, <20 day gaps - active in regime (NEW)"
      true_sparse: "<65% activity OR >20 day gaps - long dormant periods"
    scalable: "Works for all future regime-dependent strategies automatically"
  
  design_decisions:
    - "ADX >= 20 is standard definition of trending market"
    - "Goes FLAT when ADX < 20 (complements RangeFader ADX < 17)"
    - "Asymmetric thresholds reduce whipsaw trades"
    - "Weekly updates reduce turnover while maintaining edge"
    - "Regime scaling captures low-vol edge"
    - "medium_vol_scale = 0.8 (NOT 0.4 like V5) - optimization result"

# Optimization validation (NO FORWARD BIAS)
optimization:
  in_sample: "2000-2018 (19 years)"
  out_sample: "2019-2025 (6.9 years)"
  
  stage_1:
    parameters: "momentum_window, entry, exit, adx_threshold"
    combinations: 192
    method: "Grid search on IS data only"
    
  stage_2:
    parameters: "regime scaling (low/medium/high thresholds and scales)"
    combinations: 243
    method: "Grid search on IS data only, given best Stage 1 params"
    
  validation:
    method: "Run OOS ONCE, report honestly, never adjust parameters after"
    expected_oos: "0.45-0.55 Sharpe (in-regime)"
    acceptable_oos: "0.40-0.60 Sharpe"
    
  critical: "ADX threshold optimized on IS data only (2000-2018)"

# Usage notes
usage:
  standalone: "Use V5 (higher activity, simpler)"
  portfolio: "Use V6 (better regime specialization, complements RangeFader)"
  
  data_prep:
    - "Ensure all three CSV files have same date range"
    - "Use .canonical.csv suffix (dot not underscore)"
    - "All files must have lowercase 'date' and 'price' columns"
  
  deployment:
    - "Build V6 first, validate metrics"
    - "Build RangeFader (ADX < 17)"
    - "Combine with regime-adaptive weights"
    - "Expected portfolio Sharpe: 0.75-0.85"