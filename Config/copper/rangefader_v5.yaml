# Config/Copper/rangefader_v5.yaml
# RangeFader v5 - Mean Reversion with OHLC ADX Fix

io:
  commodity: Copper
  sleeve: RangeFader_v5

policy:
  calendar:
    exec_weekdays: [0, 1, 2, 3, 4]  # Mon-Fri
    origin_for_exec:
      "0": "-1B"
      "1": "-1B"
      "2": "-1B"
      "3": "-1B"
      "4": "-1B"
    fill_default: close_T

  sizing:
    ann_target: 0.10                    # 10% target vol
    vol_lookback_days_default: 63       # ~3 months rolling vol
    leverage_cap_default: 3.0           # Max 3x leverage

  costs:
    one_way_bps_default: 3.0            # 3 bps per trade (institutional reality)

  pnl:
    formula: pos_lag_times_simple_return
    t_plus_one_pnl: true                # T+1 accrual

# RangeFader v5 signal parameters (LAYER 1 ONLY)
signal:
  # Core strategy
  strategy_version: "5.0"
  description: "Mean Reversion for Choppy Markets - OHLC ADX Fix"
  architecture: "Pure signal in Layer 1, vol targeting in Layer 2, costs in Layer 4"
  
  # CRITICAL FIX FROM V4
  fix_description: "V4 used close-only ADX (underestimated by ~6 points). V5 uses proper OHLC ADX."
  impact: "More accurate regime detection: 13% choppy (V5) vs 26% (V4). Higher quality trades."
  
# Mean reversion parameters (OPTIMIZED 2025-11-19)
  lookback_window: 60                   # 60-day MA (optimized from 30-70 range)
  zscore_entry: 0.7                     # 0.7 std to enter (optimized from 0.6-1.0 range)
  zscore_exit: 0.2                      # 0.2 std to exit (optimal in all tests)
  reason_asymmetric: "Enter at 0.7 std (moderate deviation), exit quickly at 0.2, balances activity vs quality"
  
  # Regime filter (critical for avoiding weak trends)
  adx_threshold: 20.0                   # ADX < 20 = choppy (optimized from 15-20 range)
  adx_window: 14                        # Standard ADX calculation (fixed)
  adx_method: "OHLC"                    # CRITICAL: Uses proper OHLC (not close-only like V4)
  reason_adx_20: "Optimized threshold - captures 68% of choppy activity while avoiding false signals"
  
  # Update frequency
  update_frequency: 1                   # Daily updates (not weekly)
  reason_daily: "Mean reversion extremes are fleeting, need fast response"
  
  # Optional filters (future enhancements)
  use_tightness_filter: false           # Not yet implemented
  use_macro_filter: false               # Not yet implemented
  
  # Notes on Layer 1
  notes:
    - "Pure signal generation with OHLC ADX regime filtering"
    - "FIXED: ADX now uses proper high/low/close (not close-only approximation)"
    - "Regime filtering is STRATEGIC (when to trade), not calibration"
    - "Vol targeting applied separately in Layer 2 (closed-loop EWMA)"
    - "Costs applied once on net portfolio in Layer 4"
    - "Expected raw signal: -1 to +1 (no regime scaling, just binary)"
    - "Parameters are BASELINE - run optimization to find optimal"

# Expected performance (BASELINE ESTIMATE - actual may differ)
# Run optimization to find best parameters and actual OOS performance
expected_performance:
  note: "These are baseline estimates. Run optimization for actual performance."
  
  baseline_estimate:
    gross_sharpe: 0.30                # ~0.30 before costs (baseline)
    net_sharpe: 0.25                  # ~0.25 after 3bps costs (baseline)
    annual_return: 0.025              # 2.5% @ 3bps (baseline)
    annual_vol: 0.10                  # 10% (via closed-loop vol targeting)
    max_drawdown: -0.25               # -25% (estimate)
    turnover: 10.0                    # 10x annual (depends on params)
    activity: 0.10                    # 10% time in market
    
  regime_specific:
    choppy_sharpe: 0.60               # 0.60+ target in choppy (ADX < 17)
    choppy_pct_time: 0.13             # 13% of time (proper OHLC ADX)
    trending_sharpe: 0.0              # ~0 in trends (correctly goes flat)
  
  optimization_targets:
    overall_is_sharpe: ">0.30"        # In-sample target
    overall_oos_sharpe: ">0.25"       # Out-of-sample target
    choppy_is_sharpe: ">0.60"         # Choppy market target
    choppy_oos_sharpe: ">0.40"        # Choppy OOS target
    oos_is_ratio: ">0.50"             # OOS/IS decay limit
    
  validation:
    data_period: "2000-2025"
    observations: "~6700"
    note: "Parameters MUST be optimized on pre-2019 data only (IS)"

# Cost impact analysis
cost_analysis:
  baseline_gross_sharpe: 0.30
  cost_drag: 0.05                   # ~0.05 Sharpe points @ 3bps (depends on turnover)
  baseline_net_sharpe: 0.25
  cost_as_pct_gross: ~0.15          # ~15% of gross returns (depends on turnover)
  note: "Lower turnover = lower costs. Optimize for this."

# Portfolio contribution
portfolio_metrics:
  correlation_trendimpulse: "LOW"   # Orthogonal strategies
  correlation_trendmedium: "LOW"    # Very low correlation
  diversification: "EXCELLENT - fills choppy market gap"
  
  standalone_net_sharpe: 0.25       # Baseline estimate
  role: "Choppy market specialist, complements trend strategies"
  
  regime_adaptive_blend:
    allocation: "Dynamic based on ADX regime"
    expected_sharpe: 0.75             # Combined portfolio target
    improvement: "Fills 13% of time when trends fail"
  
  recommendation: "Essential for regime completeness. Optimize parameters before deploy."

# V5 vs V4 Comparison
vs_v4:
  v4_adx_method: "Close-only approximation (WRONG)"
  v4_choppy_pct: "25.8% (too loose)"
  v4_issue: "Underestimated ADX by ~6 points, included false choppy periods"
  
  v5_adx_method: "Proper OHLC calculation (CORRECT)"
  v5_choppy_pct: "13.4% (more accurate)"
  v5_fix: "Correct ADX → better regime detection → higher quality trades"
  
  key_improvements:
    - "Proper OHLC ADX (not close-only approximation)"
    - "More accurate regime classification (13% vs 26% choppy)"
    - "Higher quality trades in target regime"
    - "Regime validation framework"
    - "Systematic parameter optimization"
    - "Better risk profile"

# Known failure modes and mitigations
risk_management:
  failure_modes:
    structural_breaks:
      description: "COVID-style shocks - mean reversion fails"
      reason: "Not normal oscillation, regime shift"
      mitigation: "Future: Add ChopCore overlay for macro confusion"
    
    directional_grinds:
      description: "Low ADX but directional (China 2015-16)"
      reason: "ADX low but not oscillating"
      mitigation: "Future: Add directional filter or reduce size"
    
    parameter_drift:
      description: "Optimal params change over time"
      reason: "Market regime evolution"
      mitigation: "Quarterly parameter review, walk-forward validation"
  
  general:
    - "Portfolio context: RangeFader is 1 of 3+ strategies"
    - "Volatility targeting: Position sizes adjust to conditions"
    - "Max drawdown: -25% acceptable for 0.60+ Sharpe in target regime"
    - "Future: TightnessIndex overlay prevents fading supply shocks"
    - "Future: ChopCore overlay detects macro confusion periods"
    - "Regular optimization: Re-run every 6-12 months"

# Data requirements
data:
  required:
    - copper_lme_3mo.canonical.csv          # Close prices
    - copper_lme_3mo_high.canonical.csv     # High prices (NEW in V5)
    - copper_lme_3mo_low.canonical.csv      # Low prices (NEW in V5)
  
  optional:
    - tightness_index.csv             # Future: Supply shock filter
    - chop_core.csv                   # Future: Macro confusion filter
  
  notes:
    - "CRITICAL: V5 requires OHLC data (not just close like V4)"
    - "Strategy self-generates regime classification from ADX"
    - "Lookback window requires warmup days"
    - "ADX needs 28 days for calculation (14 * 2)"

# Architecture notes
architecture:
  layer_1: "generate_rangefader_signal() - pure signal with OHLC ADX filtering"
  layer_2: "apply_vol_targeting() - closed-loop EWMA targeting"
  layer_3: "Single sleeve for now (future: regime-based blending)"
  layer_4: "execute_single_sleeve() - costs once on net position"
  
  critical:
    - "OHLC ADX filtering is STRATEGIC (Layer 1), not calibration"
    - "NO vol targeting in signal function"
    - "Costs applied ONCE on net portfolio (institutional standard)"
    - "Closed-loop vol targeting ensures 10% realized vol"
    - "All validation checks must pass"
  
  design_decisions:
    - "Proper OHLC ADX for accurate regime detection"
    - "Asymmetric thresholds (0.6/0.2) reduce whipsaw"
    - "Daily updates capture fleeting mean reversion"
    - "ADX < 17 avoids weak trend trap"
    - "Parameter optimization required before deploy"

# Optimization protocol
optimization:
  required: true
  script: "scripts\\run_rangefader_v5_optimize.bat"
  
  parameter_space:
    lookback_window: [30, 40, 50, 60, 70]
    zscore_entry: [0.6, 0.8, 1.0, 1.2]
    zscore_exit: [0.2, 0.3, 0.4]
    adx_threshold: [15, 17, 20]
  
  split:
    in_sample: "2000-2018 (19 years)"
    out_sample: "2019-2025 (6.9 years)"
    rule: "NEVER touch OOS during optimization"
  
  targets:
    overall_sharpe_is: ">0.30"
    overall_sharpe_oos: ">0.25"
    choppy_sharpe_is: ">0.60"
    oos_is_ratio: ">0.50"
    regime_validation: "ALL PASS"
  
  workflow:
    1: "Run optimization: run_rangefader_v5_optimize.bat"
    2: "Review optimization_summary.json"
    3: "Update this config file with best parameters"
    4: "Run full build: run_rangefader_v5.bat"
    5: "Validate regime behavior"
    6: "Test in portfolio"

# Future enhancements
future_work:
  overlays:
    tightness_filter:
      description: "Don't fade in extreme physical tightness"
      reason: "Supply shocks aren't mean reverting"
      implementation: "TightnessIndex overlay"
      timeline: "Month 2"
    
    macro_confusion_filter:
      description: "Reduce positions during high uncertainty"
      reason: "COVID showed mean reversion fails in confusion"
      implementation: "ChopCore overlay"
      timeline: "Month 3"
    
    directional_filter:
      description: "Don't fade during persistent grinds"
      reason: "China 2015-16 showed low ADX but directional"
      implementation: "Trend strength + ADX combination"
      timeline: "Month 4"
  
  timeline:
    - "Week 1: Optimize parameters (IMMEDIATE)"
    - "Week 2: Validate OOS performance"
    - "Week 3: Regime portfolio integration"
    - "Month 2: TightnessIndex overlay"
    - "Month 3: ChopCore overlay"
    - "Quarterly: Parameter re-optimization"
