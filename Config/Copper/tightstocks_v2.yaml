# Config/Copper/tightstocks_v2.yaml
# TightStocks v2 - Continuous IIS Signal with Fixed Vol Targeting
# Physical market fundamental edge systematized

# Version history:
# v1 (Nov 15, 2025): Initial implementation - vol targeting misclassified as "sparse"
# v2 (Nov 21, 2025): Fixed vol targeting classification to "always_on"

# Metadata
io:
  commodity: Copper
  sleeve: TightStocks_v2
  description: "Continuous Inventory Investment Surprise signal from global exchange stocks"
  strategy_type: "quantamental"  # Combines fundamental data with systematic execution

# Layer A policy (immutable contract)
policy:
  calendar:
    frequency: daily
    timezone: UTC
    
  sizing:
    ann_target: 0.10  # 10% annualized vol target
    vol_lookback_days_default: 21
    leverage_cap_default: 2.5
    strategy_type: always_on  # FIXED: Was "sparse" in v1
    # CRITICAL: TightStocks is 'always_on' despite appearing sparse statistically
    # Reasoning:
    #   - Signal continuously calculates IIS from exchange stocks every day
    #   - Flat periods (52.7% of time) = IIS >= 0 (stocks building, signal says stay out)
    #   - Small positions (0.01-0.25) = proportional to signal strength (intentional)
    #   - Position = max(0, -IIS/2) is ALWAYS evaluated, not regime-dependent
    #   - NOT like TrendImpulse which truly turns off during chop regimes
    # v1 issue:
    #   - "sparse" classification caused 71.5% vol undershoot (2.85% vs 10% target)
    #   - Used underlying vol × typical_exposure method (wrong for continuous signals)
    # v2 fix:
    #   - "always_on" uses strategy returns directly (correct for continuous signals)
    #   - Should achieve 10% vol target with appropriate leverage
    
  costs:
    one_way_bps_default: 3.0  # LME copper typical spread
    cost_model: linear_per_trade
    
  pnl:
    t_plus_one_pnl: true  # REQUIRED: T-1 position earns T return

# Layer B signal parameters
signal:
  # IIS calculation
  change_window: 10      # Days for stock change (10 = 2 weeks)
  z_window: 252          # Days for z-score normalization (252 = 1 year)
  
  # Exchange weighting
  lme_weight: 0.60       # LME is global benchmark, highest weight
  comex_weight: 0.25     # COMEX adds US flow information
  shfe_weight: 0.15      # SHFE adds China demand, discounted for noise
  
  # Position scaling  
  scale_factor: 2.0      # IIS divisor (2.0 = IIS=-2 gives pos=1.0)
  max_raw_position: 1.0  # Cap on signal (before vol targeting)
  
  # Publication lag
  signal_lag: 1          # shift(1): use T-1 stocks for T position
                         # Verified: morning publication → EOD execution

# Expected performance (after v2 fix)
expected_performance:
  sharpe_target: 0.65    # Conservative estimate with proper vol targeting
  sharpe_optimistic: 0.80  # Optimistic case
  realized_vol: 0.10     # Should hit 10% ± 1%
  correlation_vs_baseline: 0.06  # Should remain low (diversification)
  
  # v1 results (broken vol targeting):
  v1_sharpe: 0.52        # At 2.85% vol (71.5% below target)
  v1_vol: 0.0285
  
  # v2 expectations (fixed vol targeting):
  # - Vol scales from 2.85% to 10% (3.5x increase)
  # - Returns scale proportionally
  # - Sharpe may improve slightly (better capital efficiency)
  # - But also higher costs (larger positions)
  # - Conservative estimate: 0.60-0.80 Sharpe at 10% vol
  
# Signal rationale
rationale:
  economic_hypothesis: "Physical market tightness (surprise destocking) predicts price appreciation independent of technical trends"
  
  why_weighted_combination: >
    LME dominates (60%) as global benchmark.
    COMEX (25%) captures US flows and arb opportunities.
    SHFE (15%) captures China demand but discounted for data quality.
    
  why_continuous_not_binary: >
    Binary thresholds are fragile (cliff problem at -1.0 vs -1.2).
    Continuous signal uses ALL information (IIS=-1.5 > IIS=-1.0).
    More statistically stable (+16% OOS improvement in development).
    Compatible with 15% floor constraints.
    
  why_long_only: >
    Surprise destocking (IIS < 0) predicts price appreciation.
    Surprise building (IIS > 0) less predictive, so stay flat.
    Asymmetric signal reflects market structure.
    
  why_always_on_not_sparse: >
    Despite 52.7% flat time and 188-day max flat streak, TightStocks is
    a continuous signal, not regime-dependent. The long flat periods occur
    because IIS >= 0 (stocks building) which is correct behavior - the signal
    is saying "stay out", not "turned off". This is fundamentally different
    from TrendImpulse which actually turns off during chop regimes.
    
  differentiation: >
    This is THE QUANTAMENTAL EDGE.
    Not just price momentum; physical market fundamentals systematized.
    Same signals I traded discretionary at Andurand, now scalable.

# Data requirements
data:
  required_files:
    - "copper_lme_3mo.canonical.csv"                      # Price data
    - "copper_lme_onwarrant_stocks.canonical.csv"         # LME on-warrant
    - "copper_comex_stocks.canonical.csv"                 # COMEX warehouse
    - "copper_shfe_onwarrant_stocks.canonical.csv"        # SHFE on-warrant
  
  format:
    price: "date,price (lowercase)"
    stocks: "date,stocks (or exchange-specific column)"
  
  notes:
    - "SHFE data starts ~2003, limits backtest to 2004+"
    - "Use on-warrant stocks (not total) for LME/SHFE"
    - "Forward-fill stock data for weekends/holidays"
    - "Z-score requires 252 days warmup"

# Forward bias audit
forward_bias_check:
  stock_change: "Uses T and T-10 (past only) ✓"
  z_score: "Rolling window uses past 252 days only ✓"
  signal_shift: "shift(1) for publication lag ✓"
  pnl_accrual: "T-1 position earns T return ✓"
  conclusion: "NO FORWARD BIAS - production ready ✓"
  
  critical_assumption: >
    LME publishes Thursday morning (9am) with Wednesday's stocks.
    COMEX publication timing TBD - verify before production.
    If COMEX publishes AFTER LME close, need shift(2) for COMEX component.

# Version history
version_history:
  v2.0:
    date: "2025-11-21"
    changes:
      - "FIXED: Changed strategy_type from 'sparse' to 'always_on'"
      - "Reason: Continuous IIS signal, not regime-dependent"
      - "Expected: Achieve 10% vol target (was 2.85% in v1)"
      - "Expected: Sharpe 0.60-0.80 at proper vol (was 0.52 under-leveraged)"
    validation: "Pending rebuild"
    status: "Ready for testing"
    
  v1.0:
    date: "2025-11-15"
    changes:
      - "Initial implementation with continuous IIS signal"
      - "Weighted exchange combination (60/25/15)"
      - "Linear position scaling (no binary threshold)"
      - "Long-only with vol targeting"
    validation: "0.52 Sharpe at 2.85% vol (vol targeting broken)"
    issue: "Misclassified as 'sparse', caused 71.5% vol undershoot"
    status: "Superseded by v2"